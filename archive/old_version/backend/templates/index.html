<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Export Readiness Assessment</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
    <div class="container">
        <h1>Export Readiness Assessment</h1>
        <div class="chat-container">
            <div class="messages-wrapper" id="messages">
                <div class="message assistant-message">
                    Welcome to the Export Readiness Assessment! I'm here to help evaluate your business's export potential. Click "Start Assessment" when you're ready to begin.
                </div>
            </div>
        </div>
        <div class="input-container">
            <input type="text" id="user-input" placeholder="Type your message..." disabled>
            <button id="send-button" disabled>Send</button>
            <button id="start-assessment">Start Assessment</button>
        </div>
    </div>

    <script>
        $(document).ready(function() {
            // Get existing session ID from localStorage or set to null
            let sessionId = localStorage.getItem('assessmentSessionId');
            
            // If we have a stored session ID, hide the start button and enable chat
            if (sessionId) {
                enableChat();
            }
            
            function addMessage(content, isUser = false) {
                const messageDiv = $('<div></div>')
                    .addClass('message')
                    .addClass(isUser ? 'user-message' : 'assistant-message')
                    .text(content);
                $('#messages').append(messageDiv);
                $('#messages').scrollTop($('#messages')[0].scrollHeight);
            }

            function enableChat() {
                $('#user-input').prop('disabled', false);
                $('#send-button').prop('disabled', false);
                $('#start-assessment').hide();
            }

            function startNewSession() {
                sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('assessmentSessionId', sessionId);
                $.ajax({
                    url: '/api/assessment/start',
                    method: 'POST',
                    headers: {
                        'X-Session-ID': sessionId,
                        'Content-Type': 'application/json'
                    },
                    xhrFields: {
                        withCredentials: true
                    },
                    success: function(response) {
                        if (response.session_id) {
                            sessionId = response.session_id;
                            localStorage.setItem('assessmentSessionId', sessionId);
                        }
                        addMessage(response.current_step.question);
                        enableChat();
                    },
                    error: function(xhr, status, error) {
                        let errorMessage = 'Unable to start assessment. Please try again later.';
                        if (xhr.responseJSON && xhr.responseJSON.message) {
                            errorMessage = xhr.responseJSON.message;
                        }
                        addMessage(errorMessage);
                        console.error('Error:', error);
                        // Clear session on error
                        localStorage.removeItem('assessmentSessionId');
                        sessionId = null;
                        $('#start-assessment').show();
                    }
                });
            }

            $('#start-assessment').click(function() {
                startNewSession();
            });

            $('#send-button').click(function() {
                const message = $('#user-input').val().trim();
                if (!message) return;

                addMessage(message, true);
                $('#user-input').val('').prop('disabled', true);
                $('#send-button').prop('disabled', true);

                $.ajax({
                    url: '/api/assessment/respond',
                    method: 'POST',
                    headers: {
                        'X-Session-ID': sessionId,
                        'Content-Type': 'application/json'
                    },
                    xhrFields: {
                        withCredentials: true
                    },
                    data: JSON.stringify({ message: message }),
                    success: function(response) {
                        addMessage(response.message);
                        $('#user-input').prop('disabled', false);
                        $('#send-button').prop('disabled', false);
                        $('#user-input').focus();
                    },
                    error: function(xhr, status, error) {
                        if (xhr.status === 400 && xhr.responseJSON?.error === 'Invalid session') {
                            // Session expired or invalid, clear it and show start button
                            localStorage.removeItem('assessmentSessionId');
                            sessionId = null;
                            $('#start-assessment').show();
                            addMessage('Session expired. Please start a new assessment.');
                        } else {
                            let errorMessage = 'Error: Unable to process response. Please try again.';
                            if (xhr.responseJSON && xhr.responseJSON.message) {
                                errorMessage = xhr.responseJSON.message;
                            }
                            addMessage(errorMessage);
                            $('#user-input').prop('disabled', false);
                            $('#send-button').prop('disabled', false);
                        }
                        console.error('Error:', error);
                    }
                });
            });

            $('#user-input').keypress(function(e) {
                if (e.which == 13) {
                    $('#send-button').click();
                }
            });
        });
    </script>
</body>
</html> 